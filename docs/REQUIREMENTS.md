# TeleScope — Финальные требования к проекту

Документ фиксирует полный перечень требований к системе мониторинга упоминаний в Telegram. Используется как спецификация для разработки и приёмки.

---

## 1. Общее описание

**Название:** TeleScope  
**Назначение:** Дашборд для отслеживания упоминаний ключевых слов в Telegram-чатах в реальном времени.

**Ключевые свойства:**
- Мультипользовательская система: данные изолированы по пользователям.
- Регистрация и вход по email и паролю (JWT).
- Админ-панель для управления каналами, группами каналов и учётными записями.
- Сканер на базе Telethon: мониторинг чатов по ключевым словам из БД, запись упоминаний с привязкой к пользователю.

---

## 2. Технологический стек

| Компонент | Технологии |
|-----------|------------|
| Backend | FastAPI, SQLAlchemy, PostgreSQL, JWT, Telethon |
| Frontend | Next.js 16, React 19, Tailwind CSS |
| Инфраструктура | Docker, Docker Compose; опционально Nginx, Certbot |
| Деплой | `docker compose up`, скрипты `deploy.sh`, `remote-deploy.sh`, `remote-deploy.ps1` |

**Требования к окружению:**
- Python 3.11+
- Node.js 18+ (менеджер пакетов: pnpm)
- PostgreSQL

---

## 3. Функциональные требования

### 3.1. Авторизация и безопасность

| ID | Требование | Статус |
|----|------------|--------|
| A1 | Регистрация по email и паролю (мин. 8 символов). Опционально — имя. | ✅ Реализовано |
| A2 | Вход по email/паролю; ответ — JWT и данные пользователя. | ✅ Реализовано |
| A3 | Хранение JWT в localStorage; все запросы к API и WebSocket — с заголовком `Authorization: Bearer <token>`. | ✅ Реализовано |
| A4 | Защита API: эндпоинты привязаны к текущему пользователю (`get_current_user`). | ✅ Реализовано |
| A5 | Проверка владения ресурсами: при удалении/изменении keywords, chats, groups, mentions — 403 при обращении к чужому ресурсу. | ✅ Реализовано |
| A6 | WebSocket упоминаний: авторизация по токену в query (`?token=...`); без валидного токена соединение закрывается (code 4001). | ✅ Реализовано |
| A7 | Редирект неавторизованных с дашборда на `/auth`. | ✅ Реализовано |
| A8 | Редирект уже авторизованных с `/auth` на дашборд. | ✅ Реализовано |
| A9 | Первый зарегистрированный пользователь получает права администратора. | ✅ Реализовано |
| A10 | Смена пароля: PATCH `/auth/me` (currentPassword, newPassword); страница «Настройки» с формой смены пароля. | ✅ Реализовано |
| A11 | Восстановление пароля («Забыли пароль» → email с ссылкой/токеном → установка нового пароля). | ✅ Реализовано |

### 3.2. Дашборд и лента упоминаний

| ID | Требование | Статус |
|----|------------|--------|
| D1 | Управление ключевыми словами: добавление, удаление (список принадлежит текущему пользователю). | ✅ Реализовано |
| D2 | Лента упоминаний в реальном времени через WebSocket; отображаются только упоминания текущего пользователя (по `userId` в payload). | ✅ Реализовано |
| D3 | При подключении WebSocket — сразу выдача последних N упоминаний (init). | ✅ Реализовано |
| D4 | Отметка упоминания как «Лид» / снятие отметки (isLead). | ✅ Реализовано |
| D5 | Подсветка ключевого слова в тексте сообщения в ленте. | ✅ Реализовано |
| D6 | Статистика на дашборде: упоминаний сегодня, количество ключевых слов, количество лидов (реальные данные из API GET `/api/stats`). | ✅ Реализовано |
| D7 | Ссылка «К сообщению» в Telegram: поле `messageLink` в API и кнопка в ленте (t.me/c/... или аналог). | ✅ Реализовано |
| D8 | Фильтр «Только непрочитанные» в ленте (unreadOnly). | ✅ Реализовано |
| D9 | Действие «Прочитано» по одному упоминанию (PATCH `/api/mentions/:id/read`). | ✅ Реализовано |
| D10 | «Отметить все прочитанными»: POST `/api/mentions/mark-all-read`, кнопка «Всё прочитано» в ленте. | ✅ Реализовано |
| D11 | Фильтр по ключевому слову: параметр `keyword` в API, выбор в ленте (выпадающий список). | ✅ Реализовано |
| D12 | Пагинация: параметр `offset` в API, кнопка «Загрузить ещё» в ленте. | ✅ Реализовано |
| D13 | Экспорт упоминаний в CSV: GET `/api/mentions/export` с фильтрами (keyword, leadsOnly, dateFrom, dateTo), кнопка «Экспорт CSV» в ленте. | ✅ Реализовано |
| D14 | Навигация дашборда: Панель, Ключевые слова, Группы, Уведомления, Настройки («Оплата» скрыта до реализации). | ✅ Реализовано |

### 3.2.1. Семантический парсинг

| ID | Требование | Статус |
|----|------------|--------|
| SP1 | Для каждого ключевого слова можно выбрать режим: точное (подстрока) или семантическое (по смыслу). | ✅ Реализовано |
| SP2 | Упоминания от семантического и точного поиска в ленте/API не различаются по типу. | ✅ Реализовано |
| SP3 | При семантическом режиме совпадение по косинусному сходству эмбеддингов (порог в конфиге). | ✅ Реализовано |
| SP4 | Режим задаётся при создании ключевого слова (useSemantic в API). По умолчанию — точный. | ✅ Реализовано |
| SP5 | Переключатель «Точное»/«ИИ семантика» в дашборде задаёт режим по умолчанию для новых ключевых слов; у каждого ключа отображается сохранённый режим. | ✅ Реализовано |
| SP6 | Семантический поиск может быть ограничен по тарифу (проверка лимитов — при реализации тарифов). | ❌ Не реализовано |
| SP7 | При недоступности сервиса семантики ключи с use_semantic=true временно считаются как точные (подстрока). | ✅ Реализовано |
| SP8 | Кэш эмбеддингов ключевых слов; один вызов эмбеддинга на сообщение. | ✅ Реализовано |

Реализация: по умолчанию в Docker Compose сервис **semantic** — отдельный контейнер (FastAPI, эндпоинты `/embed`, `/health`); образ собирается с PyTorch только для CPU, чтобы уменьшить размер (~500 MB модели при первом запросе). Бэкенд содержит модуль `semantic.py` и обращается к сервису по HTTP при `SEMANTIC_PROVIDER=http`. Переменные: `SEMANTIC_PROVIDER`, `SEMANTIC_SERVICE_URL`, `SEMANTIC_MODEL_NAME`, `SEMANTIC_SIMILARITY_THRESHOLD`. См. раздел 6.

### 3.3. Админ-панель

| ID | Требование | Статус |
|----|------------|--------|
| M1 | Доступ только пользователям с `isAdmin`. | ✅ Реализовано |
| M2 | Управление каналами для мониторинга: добавление по @username или chat_id, название, описание, включение/выключение (enabled). | ✅ Реализовано |
| M3 | Группы каналов: создание, удаление, привязка каналов к группам. | ✅ Реализовано |
| M4 | Учётные записи: список пользователей, создание (email, имя, пароль опционально, флаг админа), переключение роли, удаление. | ✅ Реализовано |
| M5 | Управление парсером: вкладка «Парсер» — статус (работает/остановлен), режим (мульти/один пользователь), кнопки «Запустить» и «Остановить». | ✅ Реализовано |

### 3.4. Сканер Telegram (парсер)

| ID | Требование | Статус |
|----|------------|--------|
| S1 | Реализация на Telethon. | ✅ Реализовано |
| S2 | Мультипользовательский режим по умолчанию: чаты и ключевые слова из БД по всем пользователям; упоминания сохраняются с соответствующим `user_id`; в WebSocket payload передаётся `userId`. | ✅ Реализовано |
| S3 | Режим одного пользователя: `MULTI_USER_SCANNER=0` и `TG_USER_ID` — сканирование только чатов и ключевых слов этого пользователя. | ✅ Реализовано |
| S4 | Поддержка сессии через `TG_SESSION_STRING` или `TG_SESSION_NAME`. | ✅ Реализовано |
| S5 | Опционально: `TG_CHATS` — список чатов через запятую (в режиме одного пользователя); если пусто — чаты из таблицы `chats`. | ✅ Реализовано |
| S6 | Опционально: SOCKS5-прокси (`TG_PROXY_*`). | ✅ Реализовано |
| S7 | Автозапуск сканера вместе с API: `AUTO_START_SCANNER=1`. | ✅ Реализовано |

### 3.5. Уведомления

| ID | Требование | Статус |
|----|------------|--------|
| N1 | Страница/раздел «Уведомления» в дашборде. | ✅ Реализовано |
| N2 | Настройки: канал (email, Telegram-бот), что отправлять (каждое упоминание / только лиды / дайджест). | ✅ Реализовано |
| N3 | Отправка при новом упоминании/лиде (email или Telegram Bot API). | ✅ Реализовано |

### 3.6. Тарифы и оплата (опционально)

| ID | Требование | Статус |
|----|------------|--------|
| T1 | Модель подписки в БД (план, лимиты: ключевые слова, чаты, срок хранения). | ❌ Не реализовано |
| T2 | Проверка лимитов при добавлении ключевых слов и чатов. | ❌ Не реализовано |
| T3 | Интеграция с платёжным провайдером или ручное управление тарифом. | ❌ Не реализовано |
| T4 | На фронте: отображение текущего плана и лимитов, блокировка сверх лимита. | ❌ Не реализовано |

### 3.7. Настройки и профиль

| ID | Требование | Статус |
|----|------------|--------|
| P1 | Страница «Настройки» (`/settings`): отображение профиля (имя, email), форма смены пароля (текущий + новый пароль). | ✅ Реализовано |
| P2 | Эндпоинт обновления профиля и смены пароля: PATCH `/auth/me` (currentPassword, newPassword). | ✅ Реализовано |

---

## 4. API (эндпоинты)

### 4.1. Здоровье и диагностика

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/health` | Проверка доступности сервиса. |

### 4.2. Авторизация

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/auth/register` | Регистрация (email, name?, password). |
| POST | `/auth/login` | Вход (email, password). |
| GET | `/auth/me` | Текущий пользователь (по JWT). |
| PATCH | `/auth/me` | Обновление профиля и/или смена пароля (currentPassword, newPassword). |
| POST | `/auth/forgot-password` | Запрос сброса пароля (email). Всегда 200; при наличии пользователя — отправка письма со ссылкой. |
| POST | `/auth/reset-password` | Установка нового пароля по токену из письма (token, newPassword). |

### 4.3. Дашборд (требуется авторизация)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/stats` | Статистика: mentionsToday, keywordsCount, leadsCount. |
| GET | `/api/notifications/settings` | Настройки уведомлений текущего пользователя. |
| PATCH | `/api/notifications/settings` | Обновить настройки (notifyEmail, notifyTelegram, notifyMode, telegramChatId). |
| GET | `/api/keywords` | Список ключевых слов пользователя. |
| POST | `/api/keywords` | Добавить ключевое слово (text). |
| DELETE | `/api/keywords/{keyword_id}` | Удалить ключевое слово. |
| GET | `/api/mentions` | Список упоминаний (limit, offset, unreadOnly, keyword). |
| GET | `/api/mentions/export` | Экспорт в CSV (keyword, leadsOnly, dateFrom, dateTo). |
| POST | `/api/mentions/mark-all-read` | Отметить все упоминания пользователя прочитанными. |
| PATCH | `/api/mentions/{id}/lead` | Установить/снять отметку «Лид» (body: isLead). |
| PATCH | `/api/mentions/{id}/read` | Отметить прочитанным (body: isRead). |

### 4.4. Каналы и группы (требуется авторизация)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/chats` | Список чатов пользователя. |
| POST | `/api/chats` | Добавить чат (identifier, title?, description?, groupIds?, enabled?). |
| PATCH | `/api/chats/{chat_id}` | Обновить чат. |
| DELETE | `/api/chats/{chat_id}` | Удалить чат. |
| GET | `/api/chat-groups` | Список групп каналов. |
| POST | `/api/chat-groups` | Создать группу (name, description?). |
| DELETE | `/api/chat-groups/{group_id}` | Удалить группу. |

### 4.5. Админ: пользователи (только isAdmin)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/users` | Список пользователей. |
| POST | `/api/users` | Создать пользователя (email?, name?, password?, isAdmin). |
| PATCH | `/api/users/{user_id}` | Обновить пользователя (email, name, isAdmin). |
| PATCH | `/api/users/{user_id}/password` | Установить новый пароль учётной записи (body: newPassword, только админ). |
| DELETE | `/api/users/{user_id}` | Удалить пользователя. |

### 4.6. Админ: парсер (только isAdmin)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/admin/parser/status` | Статус: running, multiUser, userId?. |
| POST | `/api/admin/parser/start` | Запустить парсер. |
| POST | `/api/admin/parser/stop` | Остановить парсер. |

### 4.7. WebSocket

| Путь | Описание |
|------|----------|
| `/ws/mentions?token=<JWT>` | Лента упоминаний: при подключении — `hello`, затем `init` с последними упоминаниями; при новом упоминании — broadcast с payload (в т.ч. userId). |

---

## 5. Модель данных (основные сущности)

- **users** — id, email, name, password_hash, is_admin, created_at.
- **keywords** — id, user_id, text, use_semantic, enabled, created_at.
- **chats** — id, user_id, tg_chat_id, username, title, description, enabled, created_at; связь many-to-many с chat_groups через chat_group_links.
- **chat_groups** — id, user_id, name, description, created_at.
- **mentions** — id, user_id, keyword_text, message_text, chat_id, chat_name, chat_username, message_id, sender_id, sender_name, is_read, is_lead, created_at.

Все сущности, привязанные к пользователю (keywords, chats, chat_groups, mentions), изолированы по `user_id`.

---

## 6. Переменные окружения

### 6.1. Обязательные

| Переменная | Описание |
|------------|----------|
| `DATABASE_URL` | Подключение к PostgreSQL (например `postgresql+psycopg2://user:pass@localhost:5432/telegram_monitor`). |
| `JWT_SECRET` | Секрет для подписи JWT (в проде обязательно сменить). |
| `TG_API_ID` | API ID приложения с my.telegram.org. |
| `TG_API_HASH` | API Hash приложения. |

### 6.2. Рекомендуемые для прода

| Переменная | Описание |
|------------|----------|
| `TG_SESSION_STRING` | StringSession Telethon (работа без интерактивного входа). |

### 6.3. Опциональные (бэкенд)

| Переменная | Описание |
|------------|----------|
| `AUTO_START_SCANNER` | 1 — запускать сканер вместе с API. |
| `MULTI_USER_SCANNER` | 1 — мультипользовательский режим; 0 — один пользователь (см. TG_USER_ID). |
| `TG_USER_ID` | ID пользователя в БД при `MULTI_USER_SCANNER=0`. |
| `TG_SESSION_NAME` | Имя файла сессии Telethon (альтернатива TG_SESSION_STRING). |
| `TG_CHATS` | Список чатов через запятую (режим одного пользователя); пусто — из таблицы chats. |
| `TG_PROXY_HOST`, `TG_PROXY_PORT`, `TG_PROXY_USER`, `TG_PROXY_PASS` | SOCKS5-прокси. |
| `CORS_ORIGINS` | Разрешённые origins через запятую (для прода). |
| `SEMANTIC_PROVIDER` | `http` — запросы к отдельному контейнеру semantic (рекомендуется в проде); `local` — модель в процессе бэкенда; пусто или `none` — семантика отключена (ключи с use_semantic временно как точные). |
| `SEMANTIC_SERVICE_URL` | URL сервиса эмбеддингов при `SEMANTIC_PROVIDER=http` (в Docker Compose по умолчанию `http://semantic:8001`). |
| `SEMANTIC_MODEL_NAME` | Имя модели (в контейнере semantic или при local; по умолчанию `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`). |
| `SEMANTIC_SIMILARITY_THRESHOLD` | Порог косинусного сходства 0.0–1.0 (по умолчанию 0.7). |
| `FRONTEND_URL` | Базовый URL фронта для ссылок в письмах (восстановление пароля), например `https://app.example.com`. |
| `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`, `SMTP_FROM`, `SMTP_USE_TLS` | Настройки SMTP для отправки писем (сброс пароля, уведомления об упоминаниях). Если не заданы — письмо не отправляется. |
| `NOTIFY_TELEGRAM_BOT_TOKEN` | Токен бота **@telescopemsg_bot** для отправки уведомлений и приёма /start (Bot API). Webhook: `POST /api/telegram-webhook`. |

### 6.4. Опциональные (фронт)

| Переменная | Описание |
|------------|----------|
| `NEXT_PUBLIC_API_URL` | URL бэкенда для запросов из браузера; при деплое по IP — обязательно; при прокси с одного домена — можно пустым. |

---

## 7. Инфраструктура и деплой

- **Локальная разработка:** `uvicorn main:app --reload --host 0.0.0.0 --port 8000` (бэкенд), `pnpm dev` (фронт). Фронт: http://localhost:3000, API: http://localhost:8000.
- **Деплой:** Docker Compose (сервисы postgres, semantic, backend, frontend). Сервис `semantic` — эмбеддинги для семантического поиска (образ с PyTorch CPU-only); бэкенд обращается к нему по `SEMANTIC_SERVICE_URL`. Команда: `docker compose up -d --build`. Данные БД — volume `postgres_data`.
- **Таблицы БД:** создаются при первом запросе к API (init_db). Миграция колонки `keywords.use_semantic` выполняется автоматически в init_db. Пересоздание схемы: `python recreate_tables.py` (данные теряются).
- **Пароль PostgreSQL:** в `.env` должна быть переменная `POSTGRES_PASSWORD`; в compose она подставляется и в контейнер postgres, и в `DATABASE_URL` бэкенда. Если бэкенд падает с ошибкой «password authentication failed», пароль в БД не совпадает с тем, что в `.env` — либо задать в `.env` тот же пароль, с которым создавался том postgres, либо пересоздать том: `docker compose down -v`, затем задать `POSTGRES_PASSWORD` в `.env` и снова `docker compose up -d`.
- **Документация по установке на Ubuntu:** `docs/install-ubuntu.md`.
- **Скрипты деплоя:** `scripts/deploy.sh`, `scripts/remote-deploy.sh`, `scripts/remote-deploy.ps1` — см. `scripts/README.md`.

---

## 8. Качество и релиз

| ID | Требование | Статус |
|----|------------|--------|
| Q1 | Тесты API (pytest), при необходимости e2e критичных сценариев. | ❌ Не реализовано |
| Q2 | Деплой через Docker/Compose, CORS из env, инструкция в README. | ✅ Реализовано |

---

## 9. Сводка: что должно быть реализовано к «финалу»

**Уже реализовано и должно сохраняться:**
- Вся авторизация (включая восстановление пароля), защита API и WebSocket, редиректы.
- Дашборд: ключевые слова, лента в реальном времени, фильтры, пагинация, экспорт CSV, статистика, прочитано/лиды, ссылка на сообщение.
- Семантический парсинг: режим на ключевом слове (use_semantic), сервис эмбеддингов в отдельном контейнере (semantic), fallback на точный поиск при недоступности.
- Настройки: профиль, смена пароля.
- Админка: каналы, группы каналов, пользователи, управление парсером.
- Мультипользовательский сканер, режим одного пользователя, переменные окружения.
- Деплой: Docker Compose (postgres, semantic, backend, frontend), документация, скрипты, устранение неполадок (пароль БД).

**Требуется реализовать для полного продукта (по приоритету):**
1. **Включить в навигацию:** пункт «Оплата» после реализации тарифов.
3. **Тарифы и оплата** (если продукт платный): модель подписки, лимиты, проверка при добавлении ресурсов, интеграция с платёжным провайдером.
4. **Тесты:** API (pytest), при необходимости e2e.

Документ можно дополнять по мере появления новых требований. Связь с планом разработки: `ROADMAP.md`.
